{
  "data": {
    "createdAt": "2024-10-01T12:52:55.366Z",
    "updatedAt": "2024-10-18T14:18:24.554Z",
    "id": "iDg3JGV97prkNz9v",
    "name": "Agente Orquestrador",
    "active": false,
    "nodes": [
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "191c1aec-934c-4ba2-b396-3738b50f4d78",
                "name": "tool_calls",
                "value": "={{ $json.required_action.submit_tool_outputs.tool_calls }}",
                "type": "array"
              }
            ]
          },
          "options": {}
        },
        "id": "9fc1b46e-9ab5-41d3-81dd-c24a91fbb3c5",
        "name": "Captura Tool Calls",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -420,
          1420
        ]
      },
      {
        "parameters": {
          "fieldToSplitOut": "tool_calls",
          "options": {
            "destinationFieldName": "properties"
          }
        },
        "id": "c0e5aa0a-e679-4b88-9414-6bfc7b9dc834",
        "name": "Split Out",
        "type": "n8n-nodes-base.splitOut",
        "typeVersion": 1,
        "position": [
          -220,
          1420
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "f724eaa4-72cc-4bbd-9b1a-b279ec2c8e52",
                "name": "arguments",
                "value": "={{ $json.properties.function.arguments }}",
                "type": "object"
              }
            ]
          },
          "includeOtherFields": true,
          "options": {}
        },
        "id": "4503be7d-d9d7-4066-ac6c-d60a7421fea9",
        "name": "Separa Arguments",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          260,
          1420
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "79854708-0135-4a8b-827b-74bcd2ac8fe7",
                "name": "response",
                "value": "={{ \"success\" in $json.response.first() ? [\"Nenhum registro encontrado\"] : $json.response }}",
                "type": "array"
              }
            ]
          },
          "options": {}
        },
        "id": "bfaf290f-48f4-44d7-b46c-cd4002f942d6",
        "name": "Response",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          1720,
          1440
        ]
      },
      {
        "parameters": {
          "mode": "raw",
          "jsonOutput": "={\n\"tool_call_id\":\"{{ $('Separa Arguments').item.json[\"properties\"][\"id\"] }}\",\n\"output\": {{ JSON.stringify(JSON.stringify($json[\"response\"])) }}\n}",
          "options": {}
        },
        "id": "663ee8e0-0ee7-4f5a-87ca-b772b5cd2c3d",
        "name": "Tool Call ID",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          1940,
          1440
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "6174ef56-939f-48d8-97c5-2e458eb06267",
                "name": "thread_id",
                "value": "={{ $json[$('Variáveis Globais').item.json.assistant_id] }}",
                "type": "string"
              },
              {
                "id": "37da7440-91ec-4311-80e1-4a801a1f6b65",
                "name": "phone",
                "value": "={{ $json.phone }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "8286beac-5a05-43e1-87f7-3b33273e0086",
        "name": "Preparta thread_id",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -5160,
          1480
        ]
      },
      {
        "parameters": {
          "content": "# Entradas\n## **Zap** \n## **Chat**",
          "height": 890.9947994983759,
          "width": 4218.716280878499,
          "color": 7
        },
        "id": "feea4be8-c3da-43fa-89d5-b6b0370e3e2e",
        "name": "Sticky Note",
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -11640.884312060676,
          1440
        ]
      },
      {
        "parameters": {
          "jsCode": "$vars.thread_nova = false\nreturn items"
        },
        "id": "d2513390-5f66-47c6-8ecd-4e4ffe7e80ad",
        "name": "Variáveis Globais - Code",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -10540,
          1740
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "7fad812c-4f7b-41bb-a426-5aca9dc08bc3",
                "leftValue": "={{ $('Variáveis Globais').item.json.em_manutencao }}",
                "rightValue": "",
                "operator": {
                  "type": "boolean",
                  "operation": "true",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "286cad2d-d5e8-4864-beb7-cffc760cf53c",
        "name": "Está em manutenção?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -7340,
          1740
        ]
      },
      {
        "parameters": {
          "collection": "users",
          "options": {},
          "query": "={\n  \"phone\": \"{{ $('Variáveis Globais').item.json.user_id }}\"\n}"
        },
        "id": "77c0c903-6988-445f-afbf-e0c852a80ea9",
        "name": "MongoDB - Get User",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1,
        "position": [
          -7060,
          1960
        ],
        "alwaysOutputData": true,
        "credentials": {
          "mongoDb": {
            "id": "iRLHzNSsYJ662KTH",
            "name": "MongoDB - Chat - Blips"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "1bbb3958-988e-479e-add8-6584965f9d3f",
                "leftValue": "={{ !!Object.keys($node[\"MongoDB - Get User\"].data).length }}",
                "rightValue": 1,
                "operator": {
                  "type": "boolean",
                  "operation": "true",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "4bcc5a49-279b-4fb8-9e4f-7c3b8cdf1ec4",
        "name": "If - User Exists",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -6840,
          1960
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "b9c8dcb8-7a7d-4a06-8ad2-6fc05f1694bf",
                "name": "name",
                "value": "={{ $('Variáveis Globais').item.json.user_name }}",
                "type": "string"
              },
              {
                "id": "322f9814-b3ff-45f8-9210-47e5ee4aaf11",
                "name": "phone",
                "value": "={{ $('Variáveis Globais').item.json.user_id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "f8777200-fd99-4adc-889b-bacdc9b70ae4",
        "name": "Prepara User",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -6540,
          2140
        ],
        "alwaysOutputData": false
      },
      {
        "parameters": {
          "operation": "update",
          "collection": "users",
          "updateKey": "phone",
          "fields": "=name,phone",
          "upsert": true,
          "options": {}
        },
        "id": "2224ca7d-aa6c-41a2-a2bf-05fdadae77cf",
        "name": "MongoDB - Create User",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1,
        "position": [
          -6300,
          2140
        ],
        "credentials": {
          "mongoDb": {
            "id": "iRLHzNSsYJ662KTH",
            "name": "MongoDB - Chat - Blips"
          }
        }
      },
      {
        "parameters": {},
        "id": "d70bf1c8-1efc-4aea-93b6-cee6a00d1cd0",
        "name": "Merge - User",
        "type": "n8n-nodes-base.merge",
        "typeVersion": 2.1,
        "position": [
          -6040,
          1600
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "a481b5b5-85f3-495c-9301-fb5433b0dccc",
                "leftValue": "={{ !! $json[$('Variáveis Globais').item.json.assistant_id] }}",
                "rightValue": "'sadasdasdas'",
                "operator": {
                  "type": "boolean",
                  "operation": "true",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "f6f21754-c5e4-4199-883a-06d81c177280",
        "name": "Possui Thread salva no banco?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -5800,
          1600
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "8c73c213-25d5-4b66-95fa-f8c9b4460480",
                "leftValue": "={{ $('MongoDB - Get User').item.json[$('Variáveis Globais').item.json.assistant_id] }}",
                "rightValue": "={{ $('Possui Thread salva no banco?').item.json[$('Variáveis Globais').item.json.assistant_id] }}",
                "operator": {
                  "type": "string",
                  "operation": "notEquals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "a41f932e-492c-477a-a003-fc2979b679f1",
        "name": "Mudou a thread_id?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -5600,
          1500
        ]
      },
      {
        "parameters": {
          "collection": "messages",
          "options": {},
          "query": "={\n  \"thread_id\": \"{{ $json[$('Variáveis Globais').first().json.assistant_id] }}\",\n  \"message_date\": {\"$gte\": \"{{$now.minus(5, 'min').toISO()}}\"}\n}"
        },
        "id": "080a776c-593c-4bef-a471-903113d125b1",
        "name": "Conta as mensagens recentes",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1,
        "position": [
          -5400,
          1600
        ],
        "alwaysOutputData": true,
        "credentials": {
          "mongoDb": {
            "id": "iRLHzNSsYJ662KTH",
            "name": "MongoDB - Chat - Blips"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "2f9b9d5a-e6c8-4052-961e-89a2e11d59f5",
                "leftValue": "={{ $('Variáveis Globais').item.json.message.trim() }}",
                "rightValue": "=/limpar_thread",
                "operator": {
                  "type": "string",
                  "operation": "notEquals"
                }
              },
              {
                "id": "6afa8f21-47c3-4ebf-9b3f-85c5694c94d4",
                "leftValue": "={{!! $json._id }}",
                "rightValue": "",
                "operator": {
                  "type": "boolean",
                  "operation": "true",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "959e726e-998e-436a-a453-378470cda595",
        "name": "É para continuar a thread_id?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -4980,
          1600
        ],
        "executeOnce": true
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "e67f5454-b878-4de4-a5e0-9136f74539ad",
                "name": "thread_id",
                "value": "={{ $json.thread_id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "4f6c3e81-3caa-47aa-b566-b927797fa3c3",
        "name": "Add thread_id",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -4740,
          1600
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "b9c8dcb8-7a7d-4a06-8ad2-6fc05f1694bf",
                "name": "phone",
                "value": "={{ $('Possui Thread salva no banco?').item.json.phone }}",
                "type": "string"
              },
              {
                "id": "322f9814-b3ff-45f8-9210-47e5ee4aaf11",
                "name": "={{ $('Variáveis Globais').item.json.assistant_id }}",
                "value": "={{ $json.id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "82ccee7a-6e01-4336-8f25-1fa7c069e08b",
        "name": "Prepara atualização",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -4540,
          1920
        ],
        "alwaysOutputData": false
      },
      {
        "parameters": {
          "operation": "update",
          "collection": "users",
          "updateKey": "phone",
          "fields": "={{ $('Variáveis Globais').item.json.assistant_id }}",
          "options": {}
        },
        "id": "1c3188b3-e0bd-4c2d-9ae7-2ee07c4aa36d",
        "name": "Atualizar thread_id",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1,
        "position": [
          -4340,
          1920
        ],
        "credentials": {
          "mongoDb": {
            "id": "iRLHzNSsYJ662KTH",
            "name": "MongoDB - Chat - Blips"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "2f9b9d5a-e6c8-4052-961e-89a2e11d59f5",
                "leftValue": "={{ $('Variáveis Globais').item.json.message }}",
                "rightValue": "/limpar_thread",
                "operator": {
                  "type": "string",
                  "operation": "startsWith"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "da75e4a5-6b8a-48ac-af98-61cdd61aabcf",
        "name": "Foi uma solicitação p/ limpar?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -5940,
          2120
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "0946679f-72ec-4479-b8b6-831d4274caad",
                "name": "output",
                "value": "Nova thread criada",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "00e024de-12ba-479e-b8fe-65d316aa2650",
        "name": "Resposta chat1",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -5700,
          2120
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "2c72ca72-d1a4-4dc0-84e8-e882ecc1c42a",
                "name": "message",
                "value": "={{ $('Juntar Mensagens2').item.json.message.trim() }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "e9401031-dfd9-49fc-9224-6257a6940704",
        "name": "Set Message from Text",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -3840,
          1700
        ]
      },
      {
        "parameters": {},
        "id": "3d1e499a-020a-4463-99e5-185b137312d1",
        "name": "Merge - Message",
        "type": "n8n-nodes-base.merge",
        "typeVersion": 2.1,
        "position": [
          -3300,
          1620
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "b9c8dcb8-7a7d-4a06-8ad2-6fc05f1694bf",
                "name": "user_id",
                "value": "={{ new String($('MongoDB - Get User').first().json._id).toString() }}",
                "type": "string"
              },
              {
                "id": "322f9814-b3ff-45f8-9210-47e5ee4aaf11",
                "name": "thread_id",
                "value": "={{ $('Add thread_id').item.json.thread_id }}",
                "type": "string"
              },
              {
                "id": "c124c295-55c0-4e1e-b489-393b63ca22f7",
                "name": "message",
                "value": "={{ $json.message }}",
                "type": "string"
              },
              {
                "id": "2c10a020-ae36-4d88-a9b1-4c125058d68f",
                "name": "message_date",
                "value": "={{ $now.toISO() }}",
                "type": "string"
              },
              {
                "id": "a572d77e-c0aa-4b6f-b44b-2baa0c02a9cb",
                "name": "assistant_id",
                "value": "={{ $('Variáveis Globais').item.json.assistant_id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "1f7147fd-af9a-41dd-ab03-c511488aa308",
        "name": "Prepara mensagem",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -3060,
          1620
        ],
        "alwaysOutputData": false
      },
      {
        "parameters": {
          "operation": "insert",
          "collection": "messages",
          "fields": "user_id,thread_id,message,message_date,assistant_id",
          "options": {}
        },
        "id": "827fd461-7d4d-431f-b29c-3a35c8807f30",
        "name": "Insere a mensagem",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1,
        "position": [
          -2820,
          1620
        ],
        "credentials": {
          "mongoDb": {
            "id": "iRLHzNSsYJ662KTH",
            "name": "MongoDB - Chat - Blips"
          }
        }
      },
      {
        "parameters": {
          "collection": "messages",
          "options": {
            "sort": "{\"message_date\": 1}"
          },
          "query": "={\n  \"thread_id\": \"{{ $('Add thread_id').item.json.thread_id }}\",\n  \"process_date\": null\n}"
        },
        "id": "06ec5281-f1ff-42e8-9fe2-1761f9fd221f",
        "name": "Busca as mensagens",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1,
        "position": [
          -2400,
          1620
        ],
        "alwaysOutputData": true,
        "credentials": {
          "mongoDb": {
            "id": "iRLHzNSsYJ662KTH",
            "name": "MongoDB - Chat - Blips"
          }
        }
      },
      {
        "parameters": {
          "options": {}
        },
        "id": "b525a9af-157f-4f06-bd81-538cae27b733",
        "name": "Loop Over Items",
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          -3300,
          1900
        ]
      },
      {
        "parameters": {
          "jsCode": "const messagesArray = $('Busca as mensagens').all();\nlet allMessages = \"\";\n\nmessagesArray.forEach(item => {\n  allMessages += item.json.message + \"  \";\n});\n\nallMessages = allMessages.trim();\nreturn [{\"message\": allMessages}]"
        },
        "id": "d80e7549-4abd-431f-b6ce-fa9db371376e",
        "name": "Concatena todas mensagens",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -3060,
          1820
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "beed4a68-7ca4-480d-b203-3f43ca5c2ce5",
                "name": "process_date",
                "value": "={{ $now.toISO() }}",
                "type": "string"
              },
              {
                "id": "ed79557d-a9f1-4938-8639-2b3c86df2ce0",
                "name": "thread_id",
                "value": "={{ $('Prepara mensagem').item.json.thread_id }}",
                "type": "string"
              },
              {
                "id": "d5795955-d791-42b4-ad4e-a4c6b08bb79a",
                "name": "_id",
                "value": "={{ new String($json._id).toString() }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "6ac72c20-6b23-483f-823d-96a6a48a019d",
        "name": "Define process_date",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -3060,
          2060
        ]
      },
      {
        "parameters": {
          "operation": "update",
          "collection": "messages",
          "updateKey": "_id",
          "fields": "process_date",
          "options": {}
        },
        "id": "6052ecbd-aeb7-4ca0-908c-2b3774f39664",
        "name": "Marca para processar",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1,
        "position": [
          -2820,
          2060
        ],
        "credentials": {
          "mongoDb": {
            "id": "iRLHzNSsYJ662KTH",
            "name": "MongoDB - Chat - Blips"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "303c1752-c985-409c-88af-294c58e07484",
                "leftValue": "={{!! $json.data[0].cancelled_at }}",
                "rightValue": "",
                "operator": {
                  "type": "boolean",
                  "operation": "false",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "90ae5eae-51f0-43dc-87f4-d3ef85c974ea",
        "name": "Se cancelado",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -1440,
          1920
        ]
      },
      {
        "parameters": {
          "content": "# **Gestão das Functions** \n",
          "height": 1098.520592706266,
          "width": 2533.286424201577,
          "color": 3
        },
        "id": "af821ff6-e046-4ca6-bbc0-b184c50a24b9",
        "name": "Sticky Note1",
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -440,
          520
        ]
      },
      {
        "parameters": {
          "content": "# **Resposta** \n",
          "height": 709.8602809008241,
          "width": 749.7120236917162,
          "color": 6
        },
        "id": "2f60ad68-1156-45e3-b83f-c46cf118d5eb",
        "name": "Sticky Note2",
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -100.26503192454356,
          1620
        ]
      },
      {
        "parameters": {
          "content": "# **Espera Processamento Open AI** ",
          "height": 710.6937811131272,
          "width": 960.272849340224,
          "color": 4
        },
        "id": "f683b10b-6bd1-4eff-a008-4da5c85136b6",
        "name": "Sticky Note3",
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -1060,
          1620
        ]
      },
      {
        "parameters": {
          "content": "# **Cadastro e Controle de Threadas no Mongo** \n",
          "height": 1002.0602494127438,
          "width": 6359.718387578165
        },
        "id": "454c1415-33bf-4ada-b8fa-fb5f61620464",
        "name": "Sticky Note4",
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -7420,
          1329.0038148554077
        ]
      },
      {
        "parameters": {
          "content": "# **Retém e Concatena mensagens seguidas**",
          "height": 782.0088651269202,
          "width": 1149.5969469949175,
          "color": 5
        },
        "id": "5e3348f2-f45f-4737-bb2e-6cbf5c8a5db6",
        "name": "Sticky Note5",
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -3381.693213179652,
          1520
        ]
      },
      {
        "parameters": {
          "options": {
            "reset": "={{ $node[\"Para cada ação necessária\"].context[\"done\"] }}"
          }
        },
        "id": "e0063dd4-f73d-4177-94eb-db6c48817a73",
        "name": "Para cada ação necessária",
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          -20,
          1420
        ]
      },
      {
        "parameters": {
          "aggregate": "aggregateAllItemData",
          "options": {}
        },
        "id": "e735c135-b5f2-4fae-ab35-cb5a9d10486d",
        "name": "Junta Resultados",
        "type": "n8n-nodes-base.aggregate",
        "typeVersion": 1,
        "position": [
          260,
          1040
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "c49761c9-bbfa-4a86-8d62-396ebeeebc5d",
                "name": "output",
                "value": "={{ $json.data }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "32800b66-be19-43e1-b2bd-66ed6b295e5b",
        "name": "Prepara Resultado",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          480,
          1040
        ],
        "retryOnFail": true
      },
      {
        "parameters": {
          "amount": 2,
          "unit": "seconds"
        },
        "id": "f357892a-aedd-4c9a-a055-25e06e1e8d53",
        "name": "Espera rodar um pouco",
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1,
        "position": [
          -640,
          1963
        ],
        "webhookId": "cd9abf53-057d-487c-9bf9-2477ff777316"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "98a5af91-f163-4672-9d53-9bee20c97303",
                "leftValue": "={{ $json.last_error.code }}",
                "rightValue": "rate_limit_exceeded",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "name": "filter.operator.equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "1d5da719-78b3-41ad-b620-16cbdb75137e",
        "name": "Se Rate Limit",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -400,
          1900
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "9be99488-b9db-4adf-bd48-7d7109f34e01",
                "name": "message",
                "value": "={{ $('Concatena todas mensagens').item.json.message }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "4287f0cb-ffb2-4112-86c8-b2f5a0fcef61",
        "name": "Reprocessa Mensagem",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -260,
          2040
        ]
      },
      {
        "parameters": {
          "collection": "ativacoes",
          "options": {
            "limit": 1,
            "sort": "{\n  \"data_hora_envio\": -1\n}"
          },
          "query": "={\n  \"telefone\": \"{{ $('Variáveis Globais').first().json.phone_forcado }}\"\n}"
        },
        "id": "d7ae732a-e17a-4339-808f-c68bb8758364",
        "name": "Busca mensagem de ativação",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1.1,
        "position": [
          -2140,
          1820
        ],
        "alwaysOutputData": true,
        "credentials": {
          "mongoDb": {
            "id": "iRLHzNSsYJ662KTH",
            "name": "MongoDB - Chat - Blips"
          }
        }
      },
      {
        "parameters": {
          "url": "=https://api.openai.com/v1/threads/{{ $('Add thread_id').first().json.thread_id }}/runs",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              }
            ]
          },
          "options": {}
        },
        "id": "fbc3a268-b4df-4a1b-b8a2-788d86beb868",
        "name": "Lista Runs",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          -1660,
          1920
        ],
        "retryOnFail": true,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        },
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://api.openai.com/v1/threads/{{ $json.data[0].thread_id }}/runs/{{ $('Lista Runs').first().json.first_id }}/cancel ",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              }
            ]
          },
          "options": {}
        },
        "id": "08ca65e0-4187-47ed-abe7-24f722d6ecd4",
        "name": "Cancel Run",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          -1220,
          1920
        ],
        "retryOnFail": true,
        "executeOnce": false,
        "maxTries": 5,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        }
      },
      {
        "parameters": {
          "url": "=https://api.openai.com/v1/threads/{{ $json.thread_id }}/messages?order=desc",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "options": {}
        },
        "id": "be139535-dc60-47a0-8c5d-039fc197235f",
        "name": "Pega Resposta Open AI",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          -400,
          1720
        ],
        "retryOnFail": true,
        "maxTries": 5,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://api.openai.com/v1/threads/{{ $('Get Run Status').item.json[\"thread_id\"] }}/runs/{{ $('Get Run Status').item.json[\"id\"] }}/submit_tool_outputs",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"tool_outputs\":{{ $json.output }}\n}\n",
          "options": {}
        },
        "id": "a784ed27-d853-4508-838d-0a833fba5555",
        "name": "Insere Output",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          720,
          1040
        ],
        "retryOnFail": true,
        "maxTries": 5,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.openai.com/v1/threads",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              },
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              }
            ]
          },
          "options": {}
        },
        "id": "bc56f8e1-acf3-4dd7-91b0-a5d6699c309e",
        "name": "Criar Thread",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          -4740,
          1920
        ],
        "retryOnFail": true,
        "maxTries": 5,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "7e8aee3a-54b3-47b8-b546-3f90fb3f036a",
                "name": "output",
                "value": "={{ $json.resposta }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "ccb04b2e-ea63-4b34-8368-f50c1fdb248f",
        "name": "Resposta chat",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          160,
          1860
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "85e6ca8f-6b7b-4af4-980f-7a72a7d9d088",
                "name": "output",
                "value": "={{$json.data[0].content[0].text.value.split('<Exemplo>')[0].trim().replaceAll('\\n', '\\\\n').replaceAll('\"', '')}}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "3357ee2c-7eff-4f38-a9bf-434fba2c786a",
        "name": "Formata",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -80,
          1720
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "ccc349c8-e64f-45d7-bd3f-551a8a58a2ee",
                "leftValue": "={{ $('Variáveis Globais').item.json.chat }}",
                "rightValue": "",
                "operator": {
                  "type": "boolean",
                  "operation": "true",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "7f1275ea-9cdb-44a4-b3e1-526a5d855614",
        "name": "É chat?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -7060,
          1620
        ]
      },
      {
        "parameters": {
          "aggregate": "aggregateAllItemData",
          "destinationFieldName": "response",
          "options": {}
        },
        "id": "613d2f45-b9a6-4464-9831-55d754bd640c",
        "name": "Aggregate",
        "type": "n8n-nodes-base.aggregate",
        "typeVersion": 1,
        "position": [
          1520,
          960
        ]
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={\n  \"text\": \"{{ $json.resposta }}\"\n}",
          "options": {}
        },
        "id": "c055493e-752c-4ecc-9503-eeb76ea2f5e6",
        "name": "Respond to Webhook1",
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.1,
        "position": [
          160,
          2020
        ]
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "957ba458-7a73-4c85-aa32-e0601292709b",
                      "leftValue": "={{ $('Variáveis Globais').item.json.message_type }}",
                      "rightValue": "image",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Image"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $('Variáveis Globais').item.json.message_type }}",
                      "rightValue": "text",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Text"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "ff160489-60f4-4fde-b3e7-0f69c9593f90",
                      "leftValue": "={{ $('Variáveis Globais').item.json.message_type }}",
                      "rightValue": "audio",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Audio"
              }
            ]
          },
          "options": {}
        },
        "id": "e7af1535-994b-4d05-a9fd-ce05ba6776e4",
        "name": "Tipo de Mensagem",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3,
        "position": [
          -4340,
          1700
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "65586f74-346f-4f40-bc3d-8b17ca6918c5",
                "leftValue": "={{ $('Variáveis Globais').item.json.repetir }}",
                "rightValue": "0",
                "operator": {
                  "type": "string",
                  "operation": "notEquals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "ba84053f-dad0-4a72-ac9e-030c04c43759",
        "name": "enviar ultima resposta?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -4540,
          1600
        ]
      },
      {
        "parameters": {
          "url": "=https://api.openai.com/v1/threads/{{ $json.thread_id }}/messages?order=desc",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "options": {}
        },
        "id": "c688320e-c1ef-4cce-9420-e58482e20b01",
        "name": "Pega Resposta Open AI1",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          -4340,
          1420
        ],
        "retryOnFail": true,
        "maxTries": 5,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "85e6ca8f-6b7b-4af4-980f-7a72a7d9d088",
                "name": "resposta",
                "value": "={{$json.data[0].content[0].text.value.replaceAll(/【[^】]*】/g, \"\").replaceAll('\\n', 'QUEBRALINHA')}}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "8a0bf4ef-419b-4a18-87d5-a2110ce67589",
        "name": "Formata1",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -4120,
          1420
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "d5ede31e-cae1-4745-ad18-18d0d651b23c",
                "leftValue": "={{ $json.resposta }}",
                "rightValue": "ativação",
                "operator": {
                  "type": "string",
                  "operation": "contains"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "dfe2f95b-d4e0-460e-9c68-f0241181059f",
        "name": "Fala da mensagem de ativação?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -3900,
          1420
        ]
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={\n  \"text\": \"Vou te encaminhar para um atendente\"\n}",
          "options": {}
        },
        "id": "23bbf2ae-e990-4445-982a-e8bd29df5eb8",
        "name": "Encaminha Atendimento",
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.1,
        "position": [
          -3720,
          1340
        ]
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={\n  \"text\": \"{{ $json.resposta }}\"\n}",
          "options": {}
        },
        "id": "0c8412f9-e461-49ff-ba57-34e4182346ca",
        "name": "Responde última mensagem",
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.1,
        "position": [
          -3720,
          1500
        ]
      },
      {
        "parameters": {
          "authentication": "oAuth2",
          "resource": "message",
          "guildId": {
            "__rl": true,
            "value": "1258059672171319316",
            "mode": "list",
            "cachedResultName": "Bot Teste",
            "cachedResultUrl": "https://discord.com/channels/1258059672171319316"
          },
          "channelId": {
            "__rl": true,
            "value": "1278683051869863936",
            "mode": "list",
            "cachedResultName": "log",
            "cachedResultUrl": "https://discord.com/channels/1258059672171319316/1278683051869863936"
          },
          "content": "=Erro no fluxo {{ $('Variáveis Globais - Code').item.json.phone_forcado }} - {{ $now.format('dd/MM/yy - HH:mm') }}",
          "options": {}
        },
        "id": "1c4a3843-b365-4a68-bd27-f68b921cffac",
        "name": "Discord",
        "type": "n8n-nodes-base.discord",
        "typeVersion": 2,
        "position": [
          -3540,
          1340
        ],
        "credentials": {
          "discordOAuth2Api": {
            "id": "2e0894liy8HiObFy",
            "name": "Discord Bot"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "34cb3bc8-079f-43b5-8f32-78fefbc897dc",
                "name": "assistant_id",
                "value": "asst_EDCYDuJmjAFsB9R8lW0JpVhy",
                "type": "string"
              },
              {
                "id": "b6ff9a48-6fe6-4808-8a40-d6edbb9c2346",
                "name": "user_id",
                "value": "={{ $json.body.id}}",
                "type": "string"
              },
              {
                "id": "7a61cd22-7f0c-4c04-a3ed-6acf9f979424",
                "name": "message_type",
                "value": "=text",
                "type": "string"
              },
              {
                "id": "8b78c832-8cf3-430f-83b0-7bbca38e4140",
                "name": "=message",
                "value": "={{ $json.body.content.replace(/@\\d+/g, '').trim() === 'null' ? 'Olá' : $json.body.content.replace(/@\\d+/g, '').replaceAll('undefined', '').trim()}}",
                "type": "string"
              },
              {
                "id": "adf11de6-a3ee-4e3e-aed5-5a6a3025202d",
                "name": "chat",
                "value": "={{ $json.body['user-agent'] == 'chat'}}",
                "type": "boolean"
              },
              {
                "id": "74b31986-b940-4961-94ac-188108032c9c",
                "name": "audios",
                "value": "={{ $json.body.audios.split(',').filter(item => item.length > 0) }}",
                "type": "array"
              },
              {
                "id": "59b01587-dc59-4cb3-9bce-e7daa0f0c6de",
                "name": "em_manutencao",
                "value": false,
                "type": "boolean"
              },
              {
                "id": "1fb719f0-1815-42ba-b967-37ebc74fae03",
                "name": "nome_agente",
                "value": "Esperanza",
                "type": "string"
              },
              {
                "id": "d8575154-cf18-4c31-8270-4d3f26151761",
                "name": "phone_forcado",
                "value": "={{ $json.body.id.replace(/\\D/g, '').startsWith('55') ? $json.body.id.replace(/\\D/g, '').slice(2) : $json.body.id.replace(/\\D/g, '') }}",
                "type": "string"
              },
              {
                "id": "9d1a67d6-4994-45b4-9a1f-87de2bbd28cc",
                "name": "images",
                "value": "={{ $json.body.images.split(',').filter(item => item.length > 0) }}",
                "type": "array"
              },
              {
                "id": "7fcef8f4-153d-4710-a13f-4c56342f338a",
                "name": "files",
                "value": "={{ $json.body.files.split(',').filter(item => item.length > 0) }}",
                "type": "array"
              },
              {
                "id": "04da73dc-8651-4f57-9d03-f81ff815a5a2",
                "name": "repetir",
                "value": "={{ $json.body.repetir || '0'}}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "c7fda2f2-b411-4178-bd4f-bb364e85b8eb",
        "name": "Variáveis Globais",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -10780,
          1740
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "e974bbea-4269-45f3-a6eb-063107c1afe0",
                "leftValue": "={{ $json.text }}",
                "rightValue": "TRUE",
                "operator": {
                  "type": "string",
                  "operation": "contains"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "af2bc299-7a48-41a7-81a8-a3c6e56fd639",
        "name": "É pra encerrar?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -7840,
          1740
        ]
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "{\n  \"text\": \"encerrar\"\n}\n",
          "options": {}
        },
        "id": "426326cb-1076-4db2-a9c7-41855adf0e5b",
        "name": "Respond to Webhook",
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.1,
        "position": [
          -7640,
          1460
        ]
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=*Task:* Você é um interpretador de texto de um chat. Sua função é verificar se a mensagem do usuário indica a intenção de encerrar o atendimento. Responda apenas TRUE ou FALSE.\n\n*Critérios para TRUE (encerramento de conversa):*\n- O usuário se despede explicitamente ou indica que deseja encerrar a conversa.\n  - Exemplos:\n    - \"Obrigado, até mais\"\n    - \"Encerrar atendimento\"\n    - \"Até logo, tchau\"\n    - \"Foi ótimo falar com você, até a próxima\"\n    - \"Agradeço a ajuda, adeus\"\n    - \"Vou encerrar a conversa aqui\"\n    - \"Não preciso de mais nada, obrigado\"\n    - \"ok, obrigado\"\n    - \"certo, obrigado\"\n    - \"Ok\"\n    - \"Combinado\"\n    - \"Fechou\"\n    - \"Valeu\"\n\n*Critérios para FALSE (não encerrando a conversa):*\n- O usuário está pedindo para cancelar um contrato ou compra, ou quer falar com um representante.\n  - Exemplos:\n    - \"Quero cancelar um contrato/compra\"\n    - \"Quero falar com um atendente\"\n    - \"Preciso de ajuda para cancelar meu serviço\"\n    - \"Pode transferir para um representante?\"\n    - \"Como faço para cancelar minha assinatura?\"\n    - \"Preciso falar com o suporte técnico\"\n\n*Mensagem do usuário:* {{$json.message}}"
        },
        "id": "4722e312-673a-4819-9f22-7bd440689cc9",
        "name": "Basic LLM Chain",
        "type": "@n8n/n8n-nodes-langchain.chainLlm",
        "typeVersion": 1.4,
        "position": [
          -8200,
          1740
        ]
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "value": "gpt-4o-mini",
            "mode": "list",
            "cachedResultName": "gpt-4o-mini"
          },
          "options": {}
        },
        "id": "4192ce36-448b-4482-b7df-4a89ff682729",
        "name": "OpenAI Model",
        "type": "@n8n/n8n-nodes-langchain.lmOpenAi",
        "typeVersion": 1,
        "position": [
          -8180,
          1940
        ],
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "2d28e7b9-2392-46e2-8cd7-0a6ae124adf5",
                "name": "message",
                "value": "={{ \n  $('Juntar Mensagens1').item.json.message \n  + '\\n' \n  + ($json.ImageText && $json.ImageText.filter(image => image !== 'null').length > 0 \n      ? '\\n<Comprovante>\\n' \n        + $json.ImageText\n          .filter(image => image !== 'null')\n          .map(image => JSON.stringify(image, null, 2))\n          .join('\\n')\n          .replaceAll('[', '')\n          .replaceAll(']', '')\n          .replaceAll('\"', '')\n          .trim() \n        + '\\n</Comprovante>' \n      : '') \n}}\n",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "181ea4c7-5c6c-4506-999e-52e9e112a23e",
        "name": "Juntar Mensagens2",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -8420,
          1740
        ]
      },
      {
        "parameters": {
          "workflowId": "gnNdR6VzpSL8GoKN",
          "options": {}
        },
        "id": "3d516893-be04-4c5b-bdba-f542434ebeab",
        "name": "Transcreve Imagens",
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1,
        "position": [
          -8620,
          1460
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "60cd8f23-87ba-4eec-9035-aa4eae8d1342",
                "leftValue": "={{ $('Variáveis Globais').item.json.images }}",
                "rightValue": "",
                "operator": {
                  "type": "array",
                  "operation": "notEmpty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "or"
          },
          "options": {}
        },
        "id": "12d53c5e-c7d8-43f4-8516-ade78a5e0f8c",
        "name": "Tem Imagem?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -8820,
          1740
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "2d28e7b9-2392-46e2-8cd7-0a6ae124adf5",
                "name": "message",
                "value": "={{ \n  $('Juntar Mensagens').item.json.message \n  + '\\n' \n  + ($json.FileText && $json.FileText.filter(file => file !== 'null').length > 0 \n      ? '\\n<Comprovante>\\n' \n        + $json.FileText\n          .filter(file => file !== 'null')\n          .map(file => JSON.stringify(file, null, 2))\n          .join('\\n')\n          .replaceAll('[', '')\n          .replaceAll(']', '')\n          .replaceAll('\"', '')\n          .trim() \n        + '\\n</Comprovante>' \n      : '') \n}}\n",
                "type": "string"
              },
              {
                "id": "6944b1e1-01d8-4e16-bddf-b088aff438f3",
                "name": "images",
                "value": "={{ $('Variáveis Globais - Code').item.json.images}}",
                "type": "array"
              },
              {
                "id": "e807624b-b17e-4788-8bc7-95c9c75671cc",
                "name": "telefone",
                "value": "={{ $('Variáveis Globais - Code').item.json.phone_forcado }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "3c11fa18-5c81-4047-bb60-9aa97aa4be06",
        "name": "Juntar Mensagens1",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -9060,
          1740
        ]
      },
      {
        "parameters": {
          "workflowId": "6Qp4o7eNqi1fSRzz",
          "options": {}
        },
        "id": "300fd2f3-0b62-4068-a86b-8b4d58b6da33",
        "name": "Transcreve PDFs",
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1,
        "position": [
          -9320,
          1460
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "60cd8f23-87ba-4eec-9035-aa4eae8d1342",
                "leftValue": "={{ $('Variáveis Globais').item.json.files }}",
                "rightValue": "",
                "operator": {
                  "type": "array",
                  "operation": "notEmpty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "or"
          },
          "options": {}
        },
        "id": "72d61aeb-0d10-4955-a5fe-af4072c07aa2",
        "name": "Tem Arquivo?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -9540,
          1740
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "6cce3c0b-ec1f-475a-8bce-c6cb6cdd8016",
                "name": "message",
                "value": "={{ ($json.AudioText ? JSON.stringify($json.AudioText, null, 2) : \"\").replaceAll('[', '').replaceAll(']', ''). replaceAll('\"', '').trim() + '\\n' + $('Variáveis Globais - Code').item.json.message}}",
                "type": "string"
              },
              {
                "id": "e4791d1d-3c1e-4b47-a8c2-e26b7486db53",
                "name": "files",
                "value": "={{ $('Variáveis Globais - Code').item.json.files }}",
                "type": "array"
              },
              {
                "id": "35363996-3a05-4dc4-9b4e-9ef0baa96bea",
                "name": "telefone",
                "value": "={{ $('Variáveis Globais - Code').item.json.phone_forcado }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "128f8d70-373e-4765-8db1-bfbaab6886bc",
        "name": "Juntar Mensagens",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -9800,
          1740
        ]
      },
      {
        "parameters": {
          "workflowId": "m1hGhj4M5EsMTAn4",
          "options": {}
        },
        "id": "4e1d64d2-bef1-4b4c-895e-951b9ac22a08",
        "name": "Transcreve Áudios",
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1,
        "position": [
          -10060,
          1460
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "48862302-18b6-4ee8-bc64-21099312dba8",
                "leftValue": "={{$json.audios}}",
                "rightValue": "",
                "operator": {
                  "type": "array",
                  "operation": "notEmpty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "33638042-58ab-40b9-8f34-f5f1e5b313ce",
        "name": "Tem áudio?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -10280,
          1740
        ]
      },
      {
        "parameters": {},
        "id": "071a3a5e-511b-4b26-972a-aab3ad29f48a",
        "name": "Execute Workflow Trigger",
        "type": "n8n-nodes-base.executeWorkflowTrigger",
        "typeVersion": 1,
        "position": [
          -11600,
          2100
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "26d2a0d2-2a36-479d-89c4-f97424eadc01",
                "name": "arguments.mensagem",
                "value": "={{ ($json.arguments.mensagem ? $json.arguments.mensagem : $json.arguments.pergunta + ' cnpj: ' + $json.arguments.cnpj).trim() }}",
                "type": "string"
              },
              {
                "id": "9a6ac739-b3c8-4011-8d1b-403e9f655893",
                "name": "id",
                "value": "={{ $json.id_agente }}",
                "type": "string"
              },
              {
                "id": "21237808-e3f5-4d82-ad6f-28ad18e62cc5",
                "name": "name",
                "value": "={{ $json.nome_agente }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "c587ccdd-fd5c-42ba-b08d-67ad06fba77f",
        "name": "Se for chamada dew função",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -11340,
          2100
        ]
      },
      {
        "parameters": {
          "amount": 1
        },
        "id": "cab8fc2a-87d2-4269-9fa5-cd2ad4e0d7fc",
        "name": "Wait",
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          -2600,
          1620
        ],
        "webhookId": "4aff0bf4-9848-4d42-b591-9ccad7883910"
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "UedQhfVihY3cKEDP",
            "mode": "list",
            "cachedResultName": "Agentes Filhos"
          },
          "options": {}
        },
        "id": "1de025f7-5c97-4979-b9d8-d9bb8664f510",
        "name": "Consultas",
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.1,
        "position": [
          1280,
          600
        ]
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "UedQhfVihY3cKEDP",
            "mode": "list",
            "cachedResultName": "Agentes Filhos"
          },
          "options": {}
        },
        "id": "a4edb08b-f5c2-4133-8e21-bc32151ae6ac",
        "name": "Equipamentos",
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.1,
        "position": [
          1280,
          780
        ]
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "UedQhfVihY3cKEDP",
            "mode": "list",
            "cachedResultName": "Agentes Filhos"
          },
          "options": {}
        },
        "id": "02e9c4c7-d0a7-4850-8083-1327360a91d8",
        "name": "Financeiro",
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.1,
        "position": [
          1280,
          960
        ]
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "UedQhfVihY3cKEDP",
            "mode": "list",
            "cachedResultName": "Agentes Filhos"
          },
          "options": {}
        },
        "id": "e6ee80c6-6b76-47a0-84f6-08e8c4ca8f94",
        "name": "Pagamentos",
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.1,
        "position": [
          1280,
          1140
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "ccc349c8-e64f-45d7-bd3f-551a8a58a2ee",
                "leftValue": "={{ $('Variáveis Globais').first().json.chat }}",
                "rightValue": "",
                "operator": {
                  "type": "boolean",
                  "operation": "true",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "c6109f84-7e71-4514-80e7-577527490616",
        "name": "É chat?3",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -20,
          1940
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://runtime.hyperflowapis.global/api/dneeXMnM7/cobranca-ativo-n8n/EsperanzaV2",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "client_id",
                "value": "d65393f4-f062-493a-bfd0-c36aeb5d21b0"
              }
            ]
          },
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "mensagem_teste",
                "value": "={{ $json.resposta }}"
              }
            ]
          },
          "options": {}
        },
        "id": "490fc017-7e6c-4e09-b625-9e95ccf59f42",
        "name": "HTTP Request",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          160,
          2180
        ]
      },
      {
        "parameters": {},
        "id": "7a4e6580-0e41-4b64-9913-36f7d4860a65",
        "name": "Chat Trigger",
        "type": "@n8n/n8n-nodes-langchain.chatTrigger",
        "typeVersion": 1,
        "position": [
          -11600,
          1920
        ],
        "webhookId": "1b326501-1d88-4cf5-ac74-16c20b7c786e"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://api.openai.com/v1/threads/{{ $('Prepara mensagem').first().json[\"thread_id\"] }}/messages",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              }
            ]
          },
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "role",
                "value": "user"
              },
              {
                "name": "content",
                "value": "={{ $('Concatena todas mensagens').first().json.message.trim() }} \n\n<MetaDados> \n  - O telefone associado é o: {{ $('Variáveis Globais - Code').item.json.user_id }}\n<MetaDados>\n"
              }
            ]
          },
          "options": {}
        },
        "id": "ba75bb01-ff42-45ec-b355-54ea8683b2cd",
        "name": "Criar a Mensagem",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          -1860,
          1820
        ],
        "retryOnFail": true,
        "maxTries": 5,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        },
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "url": "=https://api.openai.com/v1/threads/{{ $json[\"thread_id\"] }}/runs/{{ $json[\"id\"] }}",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              }
            ]
          },
          "options": {}
        },
        "id": "fd7a0cc2-e432-4122-ba23-ff0a08aebec4",
        "name": "Get Run Status",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          -1000,
          1720
        ],
        "retryOnFail": true,
        "maxTries": 5,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://api.openai.com/v1/threads/{{ $json.thread_id }}/runs",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              }
            ]
          },
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "assistant_id",
                "value": "={{ $('Variáveis Globais').first().json.assistant_id }}"
              },
              {
                "name": "tool_choice",
                "value": "auto"
              },
              {
                "name": "parallel_tool_calls",
                "value": "={{ false }}"
              }
            ]
          },
          "options": {}
        },
        "id": "b40ecbbf-a699-43ed-b3f6-c225db60b8ce",
        "name": "Run Assistant",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          -1660,
          1720
        ],
        "retryOnFail": true,
        "maxTries": 5,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        }
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.status }}",
                      "rightValue": "queued",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "queued"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "ecd44d0c-b93e-4977-ae74-8c87eae4cf20",
                      "leftValue": "={{ $json.status }}",
                      "rightValue": "in_progress",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "in_progress"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "6f6841ae-8845-4659-9e06-06e5bd4843df",
                      "leftValue": "={{ $json.status }}",
                      "rightValue": "failed",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "failed"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "6cc26ecf-79af-4d91-bb3f-a617646e3fc8",
                      "leftValue": "={{ $json.status }}",
                      "rightValue": "completed",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "completed"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "0f93b1ee-1a9c-4586-86f8-55e0a180ca04",
                      "leftValue": "={{ $json.status }}",
                      "rightValue": "expired",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "expired"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "5e7ecc7f-ecee-439c-aa0e-80a7e110726a",
                      "leftValue": "={{ $json.status }}",
                      "rightValue": "=requires_action",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "requires_action"
              }
            ]
          },
          "options": {}
        },
        "id": "1058b852-58cf-4a24-9073-4d8055c240a2",
        "name": "Switch Status",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3,
        "position": [
          -780,
          1700
        ]
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "esperanza-orquestrador",
          "options": {}
        },
        "id": "b4684964-ddb3-4b0f-82a2-f70fb1b69f87",
        "name": "Webhook Zap",
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 1.1,
        "position": [
          -11600,
          1740
        ],
        "webhookId": "090dd032-d23d-4faf-9da1-8db9b02aeeba"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "4af2f29b-283d-42ac-91fd-1faef706fba5",
                "name": "id_agente",
                "value": "={{ $('Variáveis Globais').first().json.assistant_id }}",
                "type": "string"
              },
              {
                "id": "6a775885-e6eb-45c9-b657-6fa5f23a0deb",
                "name": "nome_agente",
                "value": "={{ $('Variáveis Globais').item.json.nome_agente +  $('Variáveis Globais').item.json.user_id}}",
                "type": "string"
              }
            ]
          },
          "includeOtherFields": true,
          "options": {}
        },
        "id": "69b51490-4c91-4187-932d-b6cfc91b3d6b",
        "name": "Argumentos + Id",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          480,
          1420
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "14652341-1825-426f-a789-12646efc7d75",
                "name": "id",
                "value": "01",
                "type": "string"
              },
              {
                "id": "eb8e7e58-99d8-463c-8d31-58d528172852",
                "name": "name",
                "value": "chat",
                "type": "string"
              }
            ]
          },
          "includeOtherFields": true,
          "options": {}
        },
        "id": "6622dcfd-461f-4a90-893e-86cdc78cc6bb",
        "name": "Identificador Chat",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -11340,
          1920
        ]
      },
      {
        "parameters": {
          "mode": "raw",
          "jsonOutput": "={\n    \"body\": {\n        \"type\": \"text\",\n        \"id\": \"{{ $json.id + $json.name}}\",\n        \"content\": \"{{ $json.chatInput || $json.arguments.mensagem }}\",\n        \"user-agent\": \"chat\"\n    }\n}",
          "options": {}
        },
        "id": "bf1d0ac4-ea0b-4ee1-b2f6-1483f5ac45f0",
        "name": "Convert to Webhook",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -11080,
          1920
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "56aa5c99-0a89-4ca8-b891-9d7cde7d56f9",
                "name": "response",
                "value": "=Você entendeu que deve ser chamada a tool ‘{{ $json.properties.function.name }}’ mas ela não existe na relação de tools conhecidas por você. Avalie as tools que você conhece e use a correta",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "e12083f4-4793-4eba-9d34-f43eb97cdf98",
        "name": "Tool Errada",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          1280,
          1460
        ]
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "490075ab-7aeb-4232-8633-b008558bafc5",
                      "leftValue": "={{ $json.properties.function.name }}",
                      "rightValue": "=function_consultas",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "function_consultas"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "f164a287-6ebf-446c-88e4-4597afb4637d",
                      "leftValue": "={{ $json.properties.function.name }}",
                      "rightValue": "function_equipamentos",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "function_equipamentos"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "65a8dddd-dfbb-45a0-87f6-4a0eb5fe4f42",
                      "leftValue": "={{ $json.properties.function.name }}",
                      "rightValue": "function_financeiro",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "function_financeiro"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "f00c39c3-9a2c-4b81-8ff4-194b91c1b89b",
                      "leftValue": "={{ $json.properties.function.name }}",
                      "rightValue": "function_pagamentos",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "function_pagamentos"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "af3bdfe9-6ba4-46b1-acc8-3e689c94c73d",
                      "leftValue": "={{ $json.properties.function.name }}",
                      "rightValue": "validar_cnpj",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "validar_cnpj"
              }
            ]
          },
          "options": {
            "fallbackOutput": "extra",
            "renameFallbackOutput": "erro"
          }
        },
        "id": "e8e2b058-3672-4653-8d87-63d592a52afa",
        "name": "Escolhe a tool que deve ser utilizada",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3,
        "position": [
          720,
          1400
        ]
      }
    ],
    "connections": {
      "Captura Tool Calls": {
        "main": [
          [
            {
              "node": "Split Out",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Split Out": {
        "main": [
          [
            {
              "node": "Para cada ação necessária",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Separa Arguments": {
        "main": [
          [
            {
              "node": "Argumentos + Id",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Response": {
        "main": [
          [
            {
              "node": "Tool Call ID",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Tool Call ID": {
        "main": [
          [
            {
              "node": "Para cada ação necessária",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Preparta thread_id": {
        "main": [
          [
            {
              "node": "Add thread_id",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Variáveis Globais - Code": {
        "main": [
          [
            {
              "node": "Tem áudio?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Está em manutenção?": {
        "main": [
          [
            {
              "node": "É chat?",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "MongoDB - Get User",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "MongoDB - Get User": {
        "main": [
          [
            {
              "node": "If - User Exists",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If - User Exists": {
        "main": [
          [
            {
              "node": "Merge - User",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Prepara User",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepara User": {
        "main": [
          [
            {
              "node": "MongoDB - Create User",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "MongoDB - Create User": {
        "main": [
          [
            {
              "node": "Merge - User",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Merge - User": {
        "main": [
          [
            {
              "node": "Possui Thread salva no banco?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Possui Thread salva no banco?": {
        "main": [
          [
            {
              "node": "Mudou a thread_id?",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Criar Thread",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Mudou a thread_id?": {
        "main": [
          [
            {
              "node": "Preparta thread_id",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Conta as mensagens recentes",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Conta as mensagens recentes": {
        "main": [
          [
            {
              "node": "É para continuar a thread_id?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "É para continuar a thread_id?": {
        "main": [
          [
            {
              "node": "Add thread_id",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Criar Thread",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Add thread_id": {
        "main": [
          [
            {
              "node": "enviar ultima resposta?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepara atualização": {
        "main": [
          [
            {
              "node": "Atualizar thread_id",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Atualizar thread_id": {
        "main": [
          [
            {
              "node": "Foi uma solicitação p/ limpar?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Foi uma solicitação p/ limpar?": {
        "main": [
          [
            {
              "node": "Resposta chat1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Merge - User",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Resposta chat1": {
        "main": [
          [
            {
              "node": "Respond to Webhook",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Set Message from Text": {
        "main": [
          [
            {
              "node": "Merge - Message",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Merge - Message": {
        "main": [
          [
            {
              "node": "Prepara mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepara mensagem": {
        "main": [
          [
            {
              "node": "Insere a mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Insere a mensagem": {
        "main": [
          [
            {
              "node": "Wait",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Busca as mensagens": {
        "main": [
          [
            {
              "node": "Loop Over Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Over Items": {
        "main": [
          [
            {
              "node": "Concatena todas mensagens",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Define process_date",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Concatena todas mensagens": {
        "main": [
          [
            {
              "node": "Busca mensagem de ativação",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Define process_date": {
        "main": [
          [
            {
              "node": "Marca para processar",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Marca para processar": {
        "main": [
          [
            {
              "node": "Loop Over Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Se cancelado": {
        "main": [
          [
            {
              "node": "Cancel Run",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Para cada ação necessária": {
        "main": [
          [
            {
              "node": "Junta Resultados",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Separa Arguments",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Junta Resultados": {
        "main": [
          [
            {
              "node": "Prepara Resultado",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepara Resultado": {
        "main": [
          [
            {
              "node": "Insere Output",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Espera rodar um pouco": {
        "main": [
          [
            {
              "node": "Get Run Status",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Se Rate Limit": {
        "main": [
          [],
          [
            {
              "node": "Reprocessa Mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Reprocessa Mensagem": {
        "main": [
          [
            {
              "node": "Criar a Mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Busca mensagem de ativação": {
        "main": [
          [
            {
              "node": "Criar a Mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Lista Runs": {
        "main": [
          [
            {
              "node": "Se cancelado",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Criar Thread",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Cancel Run": {
        "main": [
          [
            {
              "node": "Criar a Mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Pega Resposta Open AI": {
        "main": [
          [
            {
              "node": "Formata",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Insere Output": {
        "main": [
          [
            {
              "node": "Get Run Status",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Criar Thread": {
        "main": [
          [
            {
              "node": "Prepara atualização",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "É chat?": {
        "main": [
          [
            {
              "node": "Resposta chat1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Aggregate": {
        "main": [
          [
            {
              "node": "Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Tipo de Mensagem": {
        "main": [
          [],
          [
            {
              "node": "Set Message from Text",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "enviar ultima resposta?": {
        "main": [
          [
            {
              "node": "Pega Resposta Open AI1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Tipo de Mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Pega Resposta Open AI1": {
        "main": [
          [
            {
              "node": "Formata1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Formata1": {
        "main": [
          [
            {
              "node": "Fala da mensagem de ativação?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fala da mensagem de ativação?": {
        "main": [
          [
            {
              "node": "Encaminha Atendimento",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Responde última mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Encaminha Atendimento": {
        "main": [
          [
            {
              "node": "Discord",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Variáveis Globais": {
        "main": [
          [
            {
              "node": "Variáveis Globais - Code",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "É pra encerrar?": {
        "main": [
          [
            {
              "node": "Respond to Webhook",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Está em manutenção?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Basic LLM Chain": {
        "main": [
          [
            {
              "node": "É pra encerrar?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Model": {
        "ai_languageModel": [
          [
            {
              "node": "Basic LLM Chain",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Juntar Mensagens2": {
        "main": [
          [
            {
              "node": "Basic LLM Chain",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Transcreve Imagens": {
        "main": [
          [
            {
              "node": "Juntar Mensagens2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Tem Imagem?": {
        "main": [
          [
            {
              "node": "Transcreve Imagens",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Juntar Mensagens2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Juntar Mensagens1": {
        "main": [
          [
            {
              "node": "Tem Imagem?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Transcreve PDFs": {
        "main": [
          [
            {
              "node": "Juntar Mensagens1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Tem Arquivo?": {
        "main": [
          [
            {
              "node": "Transcreve PDFs",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Juntar Mensagens1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Juntar Mensagens": {
        "main": [
          [
            {
              "node": "Tem Arquivo?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Transcreve Áudios": {
        "main": [
          [
            {
              "node": "Juntar Mensagens",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Tem áudio?": {
        "main": [
          [
            {
              "node": "Transcreve Áudios",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Juntar Mensagens",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Execute Workflow Trigger": {
        "main": [
          [
            {
              "node": "Se for chamada dew função",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Se for chamada dew função": {
        "main": [
          [
            {
              "node": "Convert to Webhook",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Wait": {
        "main": [
          [
            {
              "node": "Busca as mensagens",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Financeiro": {
        "main": [
          [
            {
              "node": "Aggregate",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "É chat?3": {
        "main": [
          [
            {
              "node": "Resposta chat",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Respond to Webhook1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Chat Trigger": {
        "main": [
          [
            {
              "node": "Identificador Chat",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Pagamentos": {
        "main": [
          [
            {
              "node": "Aggregate",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Consultas": {
        "main": [
          [
            {
              "node": "Aggregate",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Equipamentos": {
        "main": [
          [
            {
              "node": "Aggregate",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Criar a Mensagem": {
        "main": [
          [
            {
              "node": "Run Assistant",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Lista Runs",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Run Status": {
        "main": [
          [
            {
              "node": "Switch Status",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Run Assistant": {
        "main": [
          [
            {
              "node": "Get Run Status",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Switch Status": {
        "main": [
          [
            {
              "node": "Espera rodar um pouco",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Espera rodar um pouco",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Se Rate Limit",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Pega Resposta Open AI",
              "type": "main",
              "index": 0
            }
          ],
          [],
          [
            {
              "node": "Captura Tool Calls",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook Zap": {
        "main": [
          [
            {
              "node": "Variáveis Globais",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Argumentos + Id": {
        "main": [
          [
            {
              "node": "Escolhe a tool que deve ser utilizada",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Identificador Chat": {
        "main": [
          [
            {
              "node": "Convert to Webhook",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Convert to Webhook": {
        "main": [
          [
            {
              "node": "Variáveis Globais",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Tool Errada": {
        "main": [
          [
            {
              "node": "Aggregate",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Escolhe a tool que deve ser utilizada": {
        "main": [
          [
            {
              "node": "Consultas",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Equipamentos",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Financeiro",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Pagamentos",
              "type": "main",
              "index": 0
            }
          ],
          [],
          [
            {
              "node": "Tool Errada",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "settings": {
      "executionOrder": "v1",
      "timezone": "America/Sao_Paulo",
      "saveManualExecutions": true,
      "callerPolicy": "workflowsFromSameOwner"
    },
    "staticData": null,
    "meta": {
      "templateCredsSetupCompleted": true
    },
    "pinData": {},
    "versionId": "c9a31d51-bf33-4b2d-b6d5-aac92405aed2",
    "triggerCount": 0,
    "tags": [
      {
        "createdAt": "2024-10-01T12:52:45.165Z",
        "updatedAt": "2024-10-01T12:52:45.165Z",
        "id": "sHPTg31YIGveJtZK",
        "name": "Esperanza V2"
      }
    ]
  }
}