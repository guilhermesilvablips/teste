{
  "data": {
    "createdAt": "2024-10-02T13:22:58.610Z",
    "updatedAt": "2024-10-07T11:58:55.541Z",
    "id": "HAMtPDQl27cpa4ee",
    "name": "Agente Consultas",
    "active": false,
    "nodes": [
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "191c1aec-934c-4ba2-b396-3738b50f4d78",
                "name": "tool_calls",
                "value": "={{ $json.required_action.submit_tool_outputs.tool_calls }}",
                "type": "array"
              }
            ]
          },
          "options": {}
        },
        "id": "75b149ac-7925-40c9-bd54-90c4d901c265",
        "name": "Captura Tool Calls",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          400,
          1340
        ]
      },
      {
        "parameters": {
          "fieldToSplitOut": "tool_calls",
          "options": {
            "destinationFieldName": "properties"
          }
        },
        "id": "f8116b57-fd5a-4ae1-b695-e9c5b9847633",
        "name": "Split Out",
        "type": "n8n-nodes-base.splitOut",
        "typeVersion": 1,
        "position": [
          600,
          1340
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "f724eaa4-72cc-4bbd-9b1a-b279ec2c8e52",
                "name": "arguments",
                "value": "={{ $json.properties.function.arguments }}",
                "type": "object"
              }
            ]
          },
          "includeOtherFields": true,
          "options": {}
        },
        "id": "017a230e-47bb-4f65-bc58-38bba2a6969a",
        "name": "Separa Arguments",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          1120,
          1340
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "79854708-0135-4a8b-827b-74bcd2ac8fe7",
                "name": "response",
                "value": "={{ \"success\" in $json.data.first() ? [\"Nenhum registro encontrado\"] : $json.data }}",
                "type": "array"
              }
            ]
          },
          "options": {}
        },
        "id": "90920064-3c1f-4ad5-8b32-1a58a650d2e9",
        "name": "Response",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          2520,
          1360
        ]
      },
      {
        "parameters": {
          "mode": "raw",
          "jsonOutput": "={\n\"tool_call_id\":\"{{ $('Separa Arguments').item.json[\"properties\"][\"id\"] }}\",\n\"output\": {{ JSON.stringify(JSON.stringify($json[\"response\"])) }}\n}",
          "options": {}
        },
        "id": "39ceeb54-e69e-487a-8d95-12e3437989c5",
        "name": "Tool Call ID",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          2740,
          1360
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "6174ef56-939f-48d8-97c5-2e458eb06267",
                "name": "thread_id",
                "value": "={{ $json[$('Variáveis Globais').item.json.assistant_id] }}",
                "type": "string"
              },
              {
                "id": "37da7440-91ec-4311-80e1-4a801a1f6b65",
                "name": "phone",
                "value": "={{ $json.phone }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "86bb3746-6a2e-4b3d-a87b-26332ccdc6b2",
        "name": "Preparta thread_id",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -3600,
          1380
        ]
      },
      {
        "parameters": {
          "content": "# Entradas\n## **Chamada de Fluxo** \n## **Chat**",
          "height": 890.9947994983759,
          "width": 804.9483124190631,
          "color": 7
        },
        "id": "c15450c1-eec1-458a-8d7c-225c250946df",
        "name": "Sticky Note",
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -6638.568155173543,
          1380
        ]
      },
      {
        "parameters": {
          "jsCode": "$vars.thread_nova = false\nreturn items"
        },
        "id": "2e7865e6-9998-4b36-b68b-dc8f7c0ab411",
        "name": "Variáveis Globais - Code",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -6000,
          1620
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "7fad812c-4f7b-41bb-a426-5aca9dc08bc3",
                "leftValue": "={{ $('Variáveis Globais').item.json.em_manutencao }}",
                "rightValue": "",
                "operator": {
                  "type": "boolean",
                  "operation": "true",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "68e43eb3-5efa-4d97-987b-2ddae4bcfa1d",
        "name": "Está em manutenção?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -5780,
          1620
        ]
      },
      {
        "parameters": {
          "collection": "users",
          "options": {},
          "query": "={\n  \"phone\": \"{{ $('Variáveis Globais').item.json.assistant_id + $('Variáveis Globais').item.json.nome_agente + $('Variáveis Globais').item.json.user_id }}\"\n}"
        },
        "id": "9660786e-2cb1-4a35-80ba-c2e779266187",
        "name": "MongoDB - Get User",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1,
        "position": [
          -5580,
          1820
        ],
        "alwaysOutputData": true,
        "credentials": {
          "mongoDb": {
            "id": "iRLHzNSsYJ662KTH",
            "name": "MongoDB - Chat - Blips"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "1bbb3958-988e-479e-add8-6584965f9d3f",
                "leftValue": "={{ !!Object.keys($node[\"MongoDB - Get User\"].data).length }}",
                "rightValue": 1,
                "operator": {
                  "type": "boolean",
                  "operation": "true",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "c4a38051-15d7-4cce-b641-3620d1105904",
        "name": "If - User Exists",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -5340,
          1820
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "b9c8dcb8-7a7d-4a06-8ad2-6fc05f1694bf",
                "name": "name",
                "value": "={{ $('Variáveis Globais').item.json.nome_agente + $('Variáveis Globais').item.json.user_id }}",
                "type": "string"
              },
              {
                "id": "322f9814-b3ff-45f8-9210-47e5ee4aaf11",
                "name": "phone",
                "value": "={{ $('Variáveis Globais').item.json.assistant_id + $('Variáveis Globais').item.json.nome_agente + $('Variáveis Globais').item.json.user_id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "59d04119-ad67-40f7-b700-1b47a41d7fef",
        "name": "Prepara User",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -5100,
          2020
        ],
        "alwaysOutputData": false
      },
      {
        "parameters": {
          "operation": "update",
          "collection": "users",
          "updateKey": "phone",
          "fields": "=name,phone",
          "upsert": true,
          "options": {}
        },
        "id": "e564a8fa-4ed1-48bc-99cc-9f11b8fae3de",
        "name": "MongoDB - Create User",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1,
        "position": [
          -4840,
          2020
        ],
        "credentials": {
          "mongoDb": {
            "id": "iRLHzNSsYJ662KTH",
            "name": "MongoDB - Chat - Blips"
          }
        }
      },
      {
        "parameters": {},
        "id": "2433d6fa-3053-4fa9-8506-fc44e5424099",
        "name": "Merge - User",
        "type": "n8n-nodes-base.merge",
        "typeVersion": 2.1,
        "position": [
          -4480,
          1480
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "a481b5b5-85f3-495c-9301-fb5433b0dccc",
                "leftValue": "={{ !! $json[$('Variáveis Globais').item.json.assistant_id] }}",
                "rightValue": "'sadasdasdas'",
                "operator": {
                  "type": "boolean",
                  "operation": "true",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "33230415-7f11-48fa-b16f-1b9a5821a1e3",
        "name": "Possui Thread salva no banco?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -4240,
          1480
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "8c73c213-25d5-4b66-95fa-f8c9b4460480",
                "leftValue": "={{ $('MongoDB - Get User').item.json[$('Variáveis Globais').item.json.assistant_id] }}",
                "rightValue": "={{ $('Possui Thread salva no banco?').item.json[$('Variáveis Globais').item.json.assistant_id] }}",
                "operator": {
                  "type": "string",
                  "operation": "notEquals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "919cc6e4-8739-4c1e-bd18-280ceedc208e",
        "name": "Mudou a thread_id?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -4040,
          1400
        ]
      },
      {
        "parameters": {
          "collection": "messages",
          "options": {},
          "query": "={\n  \"thread_id\": \"{{ $json[$('Variáveis Globais').first().json.assistant_id] }}\",\n  \"message_date\": {\"$gte\": \"{{$now.minus(6, 'hours').toISO()}}\"}\n}"
        },
        "id": "54c51a7a-3370-48ad-9f9f-43355ee2c5d9",
        "name": "Conta as mensagens recentes",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1,
        "position": [
          -3840,
          1480
        ],
        "alwaysOutputData": true,
        "credentials": {
          "mongoDb": {
            "id": "iRLHzNSsYJ662KTH",
            "name": "MongoDB - Chat - Blips"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "2f9b9d5a-e6c8-4052-961e-89a2e11d59f5",
                "leftValue": "={{ $('Variáveis Globais').item.json.message.trim() }}",
                "rightValue": "=/limpar_thread",
                "operator": {
                  "type": "string",
                  "operation": "notEquals"
                }
              },
              {
                "id": "6afa8f21-47c3-4ebf-9b3f-85c5694c94d4",
                "leftValue": "={{! $json._id }}",
                "rightValue": "",
                "operator": {
                  "type": "boolean",
                  "operation": "true",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "8f21e432-e3d1-42a9-b0cb-3118f3bca59d",
        "name": "É para continuar a thread_id?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -3420,
          1480
        ],
        "executeOnce": true
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "e67f5454-b878-4de4-a5e0-9136f74539ad",
                "name": "thread_id",
                "value": "={{ $json.thread_id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "c752e53c-f790-4762-bfc1-1b581c68890a",
        "name": "Add thread_id",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -3240,
          1380
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "b9c8dcb8-7a7d-4a06-8ad2-6fc05f1694bf",
                "name": "phone",
                "value": "={{ $('Possui Thread salva no banco?').item.json.phone }}",
                "type": "string"
              },
              {
                "id": "322f9814-b3ff-45f8-9210-47e5ee4aaf11",
                "name": "={{ $('Variáveis Globais').item.json.assistant_id }}",
                "value": "={{ $json.id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "4f415869-129f-41a7-8542-a49994818cf7",
        "name": "Prepara atualização",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -2980,
          1800
        ],
        "alwaysOutputData": false
      },
      {
        "parameters": {
          "operation": "update",
          "collection": "users",
          "updateKey": "phone",
          "fields": "={{ $('Variáveis Globais').item.json.assistant_id }}",
          "options": {}
        },
        "id": "28fbe0e0-a24c-4076-a472-58218883db69",
        "name": "Atualizar thread_id",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1,
        "position": [
          -2780,
          1800
        ],
        "credentials": {
          "mongoDb": {
            "id": "iRLHzNSsYJ662KTH",
            "name": "MongoDB - Chat - Blips"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "2f9b9d5a-e6c8-4052-961e-89a2e11d59f5",
                "leftValue": "={{ $('Variáveis Globais').item.json.message }}",
                "rightValue": "/limpar_thread",
                "operator": {
                  "type": "string",
                  "operation": "startsWith"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "bd16d6bc-8a0c-4f13-b067-1e919c225b61",
        "name": "Foi uma solicitação p/ limpar?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -4380,
          2000
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "2c72ca72-d1a4-4dc0-84e8-e882ecc1c42a",
                "name": "message",
                "value": "={{ $('Variáveis Globais - Code').item.json.message }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "428747ff-861c-47d9-988f-1eb004c42952",
        "name": "Set Message from Text",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -2680,
          1380
        ]
      },
      {
        "parameters": {},
        "id": "79a96ebb-af78-40d2-b073-fa1cd29d024b",
        "name": "Merge - Message",
        "type": "n8n-nodes-base.merge",
        "typeVersion": 2.1,
        "position": [
          -2400,
          1560
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "b9c8dcb8-7a7d-4a06-8ad2-6fc05f1694bf",
                "name": "user_id",
                "value": "={{ new String($('MongoDB - Get User').first().json._id).toString() }}",
                "type": "string"
              },
              {
                "id": "322f9814-b3ff-45f8-9210-47e5ee4aaf11",
                "name": "thread_id",
                "value": "={{ $('Add thread_id').item.json.thread_id }}",
                "type": "string"
              },
              {
                "id": "c124c295-55c0-4e1e-b489-393b63ca22f7",
                "name": "message",
                "value": "={{ $json.message }}",
                "type": "string"
              },
              {
                "id": "2c10a020-ae36-4d88-a9b1-4c125058d68f",
                "name": "message_date",
                "value": "={{ $now.toISO() }}",
                "type": "string"
              },
              {
                "id": "a572d77e-c0aa-4b6f-b44b-2baa0c02a9cb",
                "name": "assistant_id",
                "value": "={{ $('Variáveis Globais').item.json.assistant_id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "71cd6c42-dc4d-44d3-bb00-652d8636a47b",
        "name": "Prepara mensagem",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -2160,
          1560
        ],
        "alwaysOutputData": false
      },
      {
        "parameters": {
          "operation": "insert",
          "collection": "messages",
          "fields": "user_id,thread_id,message,message_date,assistant_id",
          "options": {}
        },
        "id": "07830301-5db0-4103-980d-cf3568defbfc",
        "name": "Insere a mensagem",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1,
        "position": [
          -1920,
          1560
        ],
        "credentials": {
          "mongoDb": {
            "id": "iRLHzNSsYJ662KTH",
            "name": "MongoDB - Chat - Blips"
          }
        }
      },
      {
        "parameters": {
          "collection": "messages",
          "options": {
            "sort": "{\"message_date\": 1}"
          },
          "query": "={\n  \"thread_id\": \"{{ $('Add thread_id').item.json.thread_id }}\",\n  \"process_date\": null\n}"
        },
        "id": "1755493b-24f8-44fa-bb40-dbdc934d1bf1",
        "name": "Busca as mensagens",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1,
        "position": [
          -1500,
          1560
        ],
        "alwaysOutputData": true,
        "credentials": {
          "mongoDb": {
            "id": "iRLHzNSsYJ662KTH",
            "name": "MongoDB - Chat - Blips"
          }
        }
      },
      {
        "parameters": {
          "options": {}
        },
        "id": "210d3e42-4e85-4495-ba5c-740129639817",
        "name": "Loop Over Items",
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          -2400,
          1840
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "beed4a68-7ca4-480d-b203-3f43ca5c2ce5",
                "name": "process_date",
                "value": "={{ $now.toISO() }}",
                "type": "string"
              },
              {
                "id": "ed79557d-a9f1-4938-8639-2b3c86df2ce0",
                "name": "thread_id",
                "value": "={{ $('Prepara mensagem').item.json.thread_id }}",
                "type": "string"
              },
              {
                "id": "d5795955-d791-42b4-ad4e-a4c6b08bb79a",
                "name": "_id",
                "value": "={{ new String($json._id).toString() }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "2b39185b-1563-4731-b4ff-23f4242174c2",
        "name": "Define process_date",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -2160,
          1880
        ]
      },
      {
        "parameters": {
          "operation": "update",
          "collection": "messages",
          "updateKey": "_id",
          "fields": "process_date",
          "options": {}
        },
        "id": "747232e8-133f-4cce-aa9a-b129ac5726d4",
        "name": "Marca para processar",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1,
        "position": [
          -1920,
          1880
        ],
        "credentials": {
          "mongoDb": {
            "id": "iRLHzNSsYJ662KTH",
            "name": "MongoDB - Chat - Blips"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "303c1752-c985-409c-88af-294c58e07484",
                "leftValue": "={{!! $json.data[0].cancelled_at }}",
                "rightValue": "",
                "operator": {
                  "type": "boolean",
                  "operation": "false",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "2b4b48ae-8b32-4f83-a0b3-64e50c28203b",
        "name": "Se cancelado",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -780,
          1820
        ]
      },
      {
        "parameters": {
          "content": "# **Gestão das Functions** \n",
          "height": 1086.541709877022,
          "width": 2533.286424201577,
          "color": 3
        },
        "id": "2b488bd0-60f9-49b7-af36-ef43f1996a81",
        "name": "Sticky Note1",
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          360,
          460
        ]
      },
      {
        "parameters": {
          "content": "# **Resposta** \n",
          "height": 723.5198498580262,
          "width": 660.6612971110294,
          "color": 6
        },
        "id": "7ee1a387-71e3-45ab-8d29-813b09e18539",
        "name": "Sticky Note2",
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          578.392991887388,
          1546.3404310427982
        ]
      },
      {
        "parameters": {
          "content": "# **Espera Processamento Open AI** ",
          "height": 723.5071604334839,
          "width": 966.1265124287685,
          "color": 4
        },
        "id": "3f801c5b-7c30-4da1-a31f-cbd24f18ca8f",
        "name": "Sticky Note3",
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -385.8536630885445,
          1547.1866206796435
        ]
      },
      {
        "parameters": {
          "content": "# **Cadastro e Controle de Threadas no Mongo** \n",
          "height": 1041.0325505135866,
          "width": 5448.399426588444
        },
        "id": "bca3aa70-a693-4372-840f-e790e3015a2f",
        "name": "Sticky Note4",
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -5833.071457404492,
          1230.031513754565
        ]
      },
      {
        "parameters": {
          "content": "# **Retém e Concatena mensagens seguidas**",
          "height": 823.243487338573,
          "width": 1149.5969469949175,
          "color": 5
        },
        "id": "b659e479-2a0e-49f9-b8e1-9c5f12fd7efe",
        "name": "Sticky Note5",
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -2481.693213179652,
          1418.7653777883472
        ]
      },
      {
        "parameters": {
          "options": {
            "reset": "={{ $node[\"Para cada ação necessária\"].context[\"done\"] }}"
          }
        },
        "id": "df896eca-6e74-4351-ad73-eed7ae45f136",
        "name": "Para cada ação necessária",
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          840,
          1340
        ]
      },
      {
        "parameters": {
          "aggregate": "aggregateAllItemData",
          "options": {}
        },
        "id": "fda2b7db-1f75-4f76-98db-f37a7c75692e",
        "name": "Junta Resultados",
        "type": "n8n-nodes-base.aggregate",
        "typeVersion": 1,
        "position": [
          1000,
          960
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "c49761c9-bbfa-4a86-8d62-396ebeeebc5d",
                "name": "output",
                "value": "={{ $json.data }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "360d4a7c-b21e-4c80-b74b-a249839f10f9",
        "name": "Prepara Resultado",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          1220,
          960
        ],
        "retryOnFail": true
      },
      {
        "parameters": {
          "amount": 2,
          "unit": "seconds"
        },
        "id": "e0e71f05-b755-41eb-bd2e-44669a4b669e",
        "name": "Espera rodar um pouco",
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1,
        "position": [
          40,
          1900
        ],
        "webhookId": "89d3079f-42bf-4879-87c8-e992113d8bdf"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "98a5af91-f163-4672-9d53-9bee20c97303",
                "leftValue": "={{ $json.last_error.code }}",
                "rightValue": "rate_limit_exceeded",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "name": "filter.operator.equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "a5f99bce-33b8-4f9d-9d00-3d5ac3ae3e71",
        "name": "Se Rate Limit",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          240,
          1900
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "9be99488-b9db-4adf-bd48-7d7109f34e01",
                "name": "message",
                "value": "={{ $('Concatena mensagens').item.json.message }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "e4b2f56a-0257-4351-85fb-749932364e19",
        "name": "Reprocessa Mensagem",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          420,
          1980
        ]
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.status }}",
                      "rightValue": "queued",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "queued"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "ecd44d0c-b93e-4977-ae74-8c87eae4cf20",
                      "leftValue": "={{ $json.status }}",
                      "rightValue": "in_progress",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "in_progress"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "6f6841ae-8845-4659-9e06-06e5bd4843df",
                      "leftValue": "={{ $json.status }}",
                      "rightValue": "failed",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "failed"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "6cc26ecf-79af-4d91-bb3f-a617646e3fc8",
                      "leftValue": "={{ $json.status }}",
                      "rightValue": "completed",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "completed"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "0f93b1ee-1a9c-4586-86f8-55e0a180ca04",
                      "leftValue": "={{ $json.status }}",
                      "rightValue": "expired",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "expired"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "5e7ecc7f-ecee-439c-aa0e-80a7e110726a",
                      "leftValue": "={{ $json.status }}",
                      "rightValue": "=requires_action",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "requires_action"
              }
            ]
          },
          "options": {}
        },
        "id": "17594984-9ad4-447b-8db5-e45baf19e863",
        "name": "Switch Status",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3,
        "position": [
          -100,
          1620
        ]
      },
      {
        "parameters": {
          "url": "=https://api.openai.com/v1/threads/{{ $('Add thread_id').first().json.thread_id }}/runs",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              }
            ]
          },
          "options": {}
        },
        "id": "25da5533-65b9-4b1d-b23f-b4fe19535ca7",
        "name": "Lista Runs",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          -1020,
          1840
        ],
        "retryOnFail": true,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        },
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://api.openai.com/v1/threads/{{ $json.data[0].thread_id }}/runs/{{ $('Lista Runs').first().json.first_id }}/cancel ",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              }
            ]
          },
          "options": {}
        },
        "id": "f430a6d2-fb53-4913-982e-968e8b455c33",
        "name": "Cancel Run",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          -540,
          1820
        ],
        "retryOnFail": true,
        "executeOnce": false,
        "maxTries": 5,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        }
      },
      {
        "parameters": {
          "url": "=https://api.openai.com/v1/threads/{{ $json.thread_id }}/messages?order=desc",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "options": {}
        },
        "id": "bb2ba4b4-dbcd-420c-8622-a030e6017ef9",
        "name": "Pega Resposta Open AI",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          420,
          1640
        ],
        "retryOnFail": true,
        "maxTries": 5,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://api.openai.com/v1/threads/{{ $('Get Run Status').item.json[\"thread_id\"] }}/runs/{{ $('Get Run Status').item.json[\"id\"] }}/submit_tool_outputs",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"tool_outputs\":{{ $json.output }}\n}\n",
          "options": {}
        },
        "id": "a0cf539c-eddf-4418-8d6a-78883232947a",
        "name": "Insere Output",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          1440,
          960
        ],
        "retryOnFail": true,
        "maxTries": 5,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.openai.com/v1/threads",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              },
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              }
            ]
          },
          "options": {}
        },
        "id": "ad6ca4a3-ea7d-4056-bd8e-df500bb9d64d",
        "name": "Criar Thread",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          -3180,
          1800
        ],
        "retryOnFail": true,
        "maxTries": 5,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "85e6ca8f-6b7b-4af4-980f-7a72a7d9d088",
                "name": "output",
                "value": "={{ $json.data[0].content[0].text.value.replaceAll('\\n', '\\\\n') }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "6561c3eb-5592-4dfa-82f8-b0a5b7b9f4db",
        "name": "Formata",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          680,
          1640
        ]
      },
      {
        "parameters": {},
        "id": "0f9caa53-72cf-40b2-b43b-783dd90831b6",
        "name": "Execute Workflow Trigger",
        "type": "n8n-nodes-base.executeWorkflowTrigger",
        "typeVersion": 1,
        "position": [
          -6600,
          1620
        ]
      },
      {
        "parameters": {
          "amount": 1
        },
        "id": "ed8e61ce-b764-4ab8-913e-79c7ad8165d5",
        "name": "Wait",
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          -1700,
          1560
        ],
        "webhookId": "9798817a-914d-42ce-9449-a897f722ac7a"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "34cb3bc8-079f-43b5-8f32-78fefbc897dc",
                "name": "assistant_id",
                "value": "asst_4vaXQ21eMTbOBqeJcM5IM6sg",
                "type": "string"
              },
              {
                "id": "b6ff9a48-6fe6-4808-8a40-d6edbb9c2346",
                "name": "user_id",
                "value": "={{ $json.arguments.telefone}}",
                "type": "string"
              },
              {
                "id": "7a61cd22-7f0c-4c04-a3ed-6acf9f979424",
                "name": "message_type",
                "value": "text",
                "type": "string"
              },
              {
                "id": "8b78c832-8cf3-430f-83b0-7bbca38e4140",
                "name": "=message",
                "value": "={{ $json.arguments.solicitacao + ($json.arguments.nufin ? ' nufin: ' + $json.arguments.nufin : '' ) + ($json.arguments.cnpj ? ' CNPJ: ' + $json.arguments.cnpj : '' ) }}",
                "type": "string"
              },
              {
                "id": "59b01587-dc59-4cb3-9bce-e7daa0f0c6de",
                "name": "em_manutencao",
                "value": false,
                "type": "boolean"
              },
              {
                "id": "1fb719f0-1815-42ba-b967-37ebc74fae03",
                "name": "nome_agente",
                "value": "Esperanza-Consultas",
                "type": "string"
              },
              {
                "id": "93fb1f6e-e96e-49a1-a9ec-4f9c06874c6b",
                "name": "cnpj",
                "value": "={{ $json.arguments.cnpj }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "30a61b6a-81b6-4ee1-83d7-b03e2c45e712",
        "name": "Variáveis Globais",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -6240,
          1620
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "07f4dfaf-0df1-482c-9476-17578005ed87",
                "name": "em_manutencao",
                "value": "={{ $('Variáveis Globais').item.json.em_manutencao }}",
                "type": "boolean"
              }
            ]
          },
          "options": {}
        },
        "id": "169ba1af-55bb-4d94-852a-685bdcc6b697",
        "name": "Manutencao",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -5580,
          1540
        ]
      },
      {
        "parameters": {
          "jsCode": "const messagesArray = $('Busca as mensagens').all();\nlet allMessages = \"\";\n\nmessagesArray.forEach(item => {\n  allMessages += item.json.message + \"  \";\n});\n\nallMessages = allMessages.trim();\nreturn [{\"message\": allMessages}]"
        },
        "id": "e03b7db1-2868-4b7a-92f5-2e916e3e6d9f",
        "name": "Concatena mensagens",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -2160,
          1740
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://api.openai.com/v1/threads/{{ $('Prepara mensagem').first().json[\"thread_id\"] }}/messages",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              }
            ]
          },
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "role",
                "value": "user"
              },
              {
                "name": "content",
                "value": "=<Pergunta>\n{{ $('Concatena mensagens').first().json.message.trim() }}\n</Pergunta>"
              }
            ]
          },
          "options": {}
        },
        "id": "5b718483-59b5-4ff8-838f-8cae0c4cef89",
        "name": "Criar a Mensagem",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          -1220,
          1740
        ],
        "retryOnFail": true,
        "maxTries": 5,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        },
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "0946679f-72ec-4479-b8b6-831d4274caad",
                "name": "output",
                "value": "Nova thread criada",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "d9cc1c59-a9c1-4657-b302-3b9e36f3687d",
        "name": "Resposta chat",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -4140,
          2000
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://api.openai.com/v1/threads/{{ $json.thread_id }}/runs",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              }
            ]
          },
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "assistant_id",
                "value": "={{ $('Variáveis Globais').first().json.assistant_id }}"
              },
              {
                "name": "tool_choice",
                "value": "auto"
              },
              {
                "name": "parallel_tool_calls",
                "value": "={{ false }}"
              }
            ]
          },
          "options": {}
        },
        "id": "d5e142c0-e3fa-4af1-882c-22054cb86ca6",
        "name": "Run Assistant",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          -1020,
          1640
        ],
        "retryOnFail": true,
        "maxTries": 5,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        }
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "957ba458-7a73-4c85-aa32-e0601292709b",
                      "leftValue": "={{ $('Variáveis Globais').item.json.message_type }}",
                      "rightValue": "image",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Image"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $('Variáveis Globais').item.json.message_type }}",
                      "rightValue": "text",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Text"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "ff160489-60f4-4fde-b3e7-0f69c9593f90",
                      "leftValue": "={{ $('Variáveis Globais').item.json.message_type }}",
                      "rightValue": "audio",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Audio"
              }
            ]
          },
          "options": {}
        },
        "id": "adc78a5a-c88f-4ada-8877-7ecb2f7a2903",
        "name": "Tipo de Mensagem",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3,
        "position": [
          -3020,
          1380
        ]
      },
      {
        "parameters": {
          "url": "=https://api.openai.com/v1/threads/{{ $json[\"thread_id\"] }}/runs/{{ $json[\"id\"] }}",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "OpenAI-Beta",
                "value": "assistants=v2"
              }
            ]
          },
          "options": {}
        },
        "id": "56055dbf-4c79-4d84-b190-506680eae6ec",
        "name": "Get Run Status",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          -340,
          1640
        ],
        "retryOnFail": true,
        "maxTries": 5,
        "credentials": {
          "openAiApi": {
            "id": "erBLFgb3zHf0C8ux",
            "name": "Open Ai - Cobrança"
          }
        }
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "490075ab-7aeb-4232-8633-b008558bafc5",
                      "leftValue": "={{ $json.properties.function.name }}",
                      "rightValue": "=consulta_bloqueantes",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "consulta_bloqueantes"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "f164a287-6ebf-446c-88e4-4597afb4637d",
                      "leftValue": "={{ $json.properties.function.name }}",
                      "rightValue": "consulta_cobranca",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "consulta_cobranca"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "65a8dddd-dfbb-45a0-87f6-4a0eb5fe4f42",
                      "leftValue": "={{ $json.properties.function.name }}",
                      "rightValue": "consulta_fututros",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "consulta_fututros"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "f00c39c3-9a2c-4b81-8ff4-194b91c1b89b",
                      "leftValue": "={{ $json.properties.function.name }}",
                      "rightValue": "consulta_pagos",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "consulta_pagos"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "af3bdfe9-6ba4-46b1-acc8-3e689c94c73d",
                      "leftValue": "={{ $json.properties.function.name }}",
                      "rightValue": "validar_cnpj",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "validar_cnpj"
              }
            ]
          },
          "options": {}
        },
        "id": "9e8191c9-c0ad-4c5d-9965-8600521dec7b",
        "name": "Escolhe a tool que deve ser utilizada",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3,
        "position": [
          1340,
          1340
        ]
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "AIqTlhFmd3RzNdd6",
            "mode": "list",
            "cachedResultName": "Esperanza V2 - func - consulta_bloqueantes"
          },
          "options": {}
        },
        "id": "48fe9d52-b782-4652-874f-dff26644eab8",
        "name": "consulta bloqueantes",
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.1,
        "position": [
          2080,
          520
        ]
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "d8yCYU4TGWhAJuyw",
            "mode": "list",
            "cachedResultName": "Esperanza V2 - func - consulta_cobranca"
          },
          "options": {}
        },
        "id": "0a718bc8-91a9-47a5-991d-3048bf07fe79",
        "name": "consulta_cobranca",
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.1,
        "position": [
          2080,
          700
        ]
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "mWm20N4OFKfpzq0D",
            "mode": "list",
            "cachedResultName": "Esperanza V2 - func - consulta_futuros"
          },
          "options": {}
        },
        "id": "f6dad229-05bd-4905-b0e8-d2da50fc0f0e",
        "name": "consulta_futuros",
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.1,
        "position": [
          2080,
          880
        ]
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "VHZ04dx6Z7T8tQgq",
            "mode": "list",
            "cachedResultName": "Esperanza V2 - func - consulta_pagos"
          },
          "options": {}
        },
        "id": "07ec025c-183a-4b20-b516-3bf1b20f6081",
        "name": "consulta_pagos",
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.1,
        "position": [
          2080,
          1060
        ]
      },
      {
        "parameters": {
          "options": {}
        },
        "id": "5a44ef07-e964-4156-a9a8-0af017c7e75a",
        "name": "When chat message received",
        "type": "@n8n/n8n-nodes-langchain.chatTrigger",
        "typeVersion": 1.1,
        "position": [
          -6600,
          1860
        ],
        "webhookId": "ec9525cc-5fff-4ea3-8126-16955bc0a770"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "0ae5806d-9225-4ab0-a687-0b2b94ddfcf0",
                "name": "arguments.solicitacao",
                "value": "={{ $json.chatInput }}",
                "type": "string"
              },
              {
                "id": "7a4231ff-7491-4473-adf9-7ed0b2da31ee",
                "name": "arguments.telefone",
                "value": "TESTE",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "d771740a-5eba-49c2-a3b7-28ae7a5b2a0c",
        "name": "Converte para chamada",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -6420,
          1860
        ]
      }
    ],
    "connections": {
      "Captura Tool Calls": {
        "main": [
          [
            {
              "node": "Split Out",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Split Out": {
        "main": [
          [
            {
              "node": "Para cada ação necessária",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Separa Arguments": {
        "main": [
          [
            {
              "node": "Escolhe a tool que deve ser utilizada",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Response": {
        "main": [
          [
            {
              "node": "Tool Call ID",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Tool Call ID": {
        "main": [
          [
            {
              "node": "Para cada ação necessária",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Preparta thread_id": {
        "main": [
          [
            {
              "node": "Add thread_id",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Está em manutenção?": {
        "main": [
          [
            {
              "node": "Manutencao",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "MongoDB - Get User",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "MongoDB - Get User": {
        "main": [
          [
            {
              "node": "If - User Exists",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If - User Exists": {
        "main": [
          [
            {
              "node": "Merge - User",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Prepara User",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepara User": {
        "main": [
          [
            {
              "node": "MongoDB - Create User",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "MongoDB - Create User": {
        "main": [
          [
            {
              "node": "Merge - User",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Merge - User": {
        "main": [
          [
            {
              "node": "Possui Thread salva no banco?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Possui Thread salva no banco?": {
        "main": [
          [
            {
              "node": "Mudou a thread_id?",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Criar Thread",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Mudou a thread_id?": {
        "main": [
          [
            {
              "node": "Preparta thread_id",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Conta as mensagens recentes",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Conta as mensagens recentes": {
        "main": [
          [
            {
              "node": "É para continuar a thread_id?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "É para continuar a thread_id?": {
        "main": [
          [
            {
              "node": "Add thread_id",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Criar Thread",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Add thread_id": {
        "main": [
          [
            {
              "node": "Tipo de Mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepara atualização": {
        "main": [
          [
            {
              "node": "Atualizar thread_id",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Atualizar thread_id": {
        "main": [
          [
            {
              "node": "Foi uma solicitação p/ limpar?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Foi uma solicitação p/ limpar?": {
        "main": [
          [
            {
              "node": "Resposta chat",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Merge - User",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Set Message from Text": {
        "main": [
          [
            {
              "node": "Merge - Message",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Merge - Message": {
        "main": [
          [
            {
              "node": "Prepara mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepara mensagem": {
        "main": [
          [
            {
              "node": "Insere a mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Insere a mensagem": {
        "main": [
          [
            {
              "node": "Wait",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Busca as mensagens": {
        "main": [
          [
            {
              "node": "Loop Over Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Over Items": {
        "main": [
          [
            {
              "node": "Concatena mensagens",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Define process_date",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Define process_date": {
        "main": [
          [
            {
              "node": "Marca para processar",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Marca para processar": {
        "main": [
          [
            {
              "node": "Loop Over Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Se cancelado": {
        "main": [
          [
            {
              "node": "Cancel Run",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Para cada ação necessária": {
        "main": [
          [
            {
              "node": "Junta Resultados",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Separa Arguments",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Junta Resultados": {
        "main": [
          [
            {
              "node": "Prepara Resultado",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepara Resultado": {
        "main": [
          [
            {
              "node": "Insere Output",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Espera rodar um pouco": {
        "main": [
          [
            {
              "node": "Get Run Status",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Se Rate Limit": {
        "main": [
          [],
          [
            {
              "node": "Reprocessa Mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Reprocessa Mensagem": {
        "main": [
          [
            {
              "node": "Criar a Mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Switch Status": {
        "main": [
          [
            {
              "node": "Espera rodar um pouco",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Espera rodar um pouco",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Se Rate Limit",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Pega Resposta Open AI",
              "type": "main",
              "index": 0
            }
          ],
          [],
          [
            {
              "node": "Captura Tool Calls",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Lista Runs": {
        "main": [
          [
            {
              "node": "Se cancelado",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Criar Thread",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Cancel Run": {
        "main": [
          [
            {
              "node": "Criar a Mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Pega Resposta Open AI": {
        "main": [
          [
            {
              "node": "Formata",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Insere Output": {
        "main": [
          [
            {
              "node": "Get Run Status",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Criar Thread": {
        "main": [
          [
            {
              "node": "Prepara atualização",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Execute Workflow Trigger": {
        "main": [
          [
            {
              "node": "Variáveis Globais",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Wait": {
        "main": [
          [
            {
              "node": "Busca as mensagens",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Variáveis Globais - Code": {
        "main": [
          [
            {
              "node": "Está em manutenção?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Variáveis Globais": {
        "main": [
          [
            {
              "node": "Variáveis Globais - Code",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Concatena mensagens": {
        "main": [
          [
            {
              "node": "Criar a Mensagem",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Criar a Mensagem": {
        "main": [
          [
            {
              "node": "Run Assistant",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Lista Runs",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Run Assistant": {
        "main": [
          [
            {
              "node": "Get Run Status",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Tipo de Mensagem": {
        "main": [
          [],
          [
            {
              "node": "Set Message from Text",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Run Status": {
        "main": [
          [
            {
              "node": "Switch Status",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Escolhe a tool que deve ser utilizada": {
        "main": [
          [
            {
              "node": "consulta bloqueantes",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "consulta_cobranca",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "consulta_futuros",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "consulta_pagos",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "consulta_pagos": {
        "main": [
          [
            {
              "node": "Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "consulta_futuros": {
        "main": [
          [
            {
              "node": "Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "consulta_cobranca": {
        "main": [
          [
            {
              "node": "Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "consulta bloqueantes": {
        "main": [
          [
            {
              "node": "Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "When chat message received": {
        "main": [
          [
            {
              "node": "Converte para chamada",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Converte para chamada": {
        "main": [
          [
            {
              "node": "Variáveis Globais",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "settings": {
      "executionOrder": "v1"
    },
    "staticData": null,
    "meta": {
      "templateCredsSetupCompleted": true
    },
    "pinData": {
      "Execute Workflow Trigger": [
        {
          "json": {
            "arguments": {
              "cnpj": "32565025000129",
              "solicitacao": "Consulte os títulos da cobrança do CNPJ: 32565025000129",
              "telefone": "952541165874"
            }
          }
        }
      ]
    },
    "versionId": "19d45926-444e-4eac-88ad-42ebc9d9b35f",
    "triggerCount": 0,
    "tags": [
      {
        "createdAt": "2024-10-01T12:52:45.165Z",
        "updatedAt": "2024-10-01T12:52:45.165Z",
        "id": "sHPTg31YIGveJtZK",
        "name": "Esperanza V2"
      }
    ]
  }
}